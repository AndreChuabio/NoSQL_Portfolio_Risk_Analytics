Phase 2: Risk Engine Development
================================

Identity And Context
--------------------
- Address the user as Señor Clown and acknowledge their quantitative research focus.
- Review the global instructions files before work begins.
- Confirm Phase 1 artifacts are available and documented. If gaps exist, coordinate remediation before proceeding.

Objectives
----------
1. Implement core risk calculations: VaR (Monte Carlo, 95 percent), Expected Shortfall, Sharpe ratio, and Beta.
2. Ensure calculations are vectorized with NumPy or Pandas and include thorough validation and error handling.
3. Store computed metrics in MongoDB `risk_metrics` collection with proper indexing.
4. Deliver unit tests covering deterministic scenarios and edge cases for each metric function.

Workflow Checklist
------------------
1. Design computational modules: define module layout under `src/risk_engine/` keeping responsibilities isolated (for example `var_calculator.py` and `performance_metrics.py`) and add logging setup consistent with project standards.
2. Implement risk algorithms: build VaR using a 1000 simulation Monte Carlo with historical sampling, compute Expected Shortfall as the mean of the worst five percent of outcomes, implement the rolling twenty day Sharpe ratio annualized by `sqrt(252)`, construct rolling beta versus SPY or the selected benchmark, and enforce input validation for shapes, weights, and missing data.
3. Persist results: add MongoDB helper functions to write `risk_metrics` documents keyed by `(portfolio_id, date)`, include calculated fields for VaR, ES, Sharpe, Beta, volatility, and metadata such as simulation parameters, and create or verify the index on `(portfolio_id, date)`.
4. Testing strategy: build fixtures with synthetic deterministic datasets for reproducible assertions, use `pytest` to validate outputs, edge handling, and error raising paths, and document how to run tests along with expected runtime.

Quality Gates
-------------
- Each risk function has docstrings, type hints, and logging statements for critical checkpoints.
- Unit test coverage includes happy path, invalid weights, missing data, and regression edge cases.
- MongoDB inserts succeed with schema validation confirmed via sample queries and `explain` on indexed queries.
- Performance benchmark: VaR computation for thirty assets completes in under five hundred milliseconds on reference hardware.

Exit Criteria
-------------
- All risk computation modules implemented and linted via `black` and `isort`.
- `pytest` suite passes locally with documented command and results.
- MongoDB `risk_metrics` collection populated for historical periods with expected fields.
- Open questions, if any, captured and communicated to Señor Clown before moving to Phase 3.
